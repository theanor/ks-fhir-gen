 [![Gitter](https://img.shields.io/badge/Available%20on-Intersystems%20Open%20Exchange-00b2a9.svg)](https://openexchange.intersystems.com/package/ks-fhir-gen)
 [![Quality Gate Status](https://community.objectscriptquality.com/api/project_badges/measure?project=intersystems_iris_community__ks-fhir-gen&metric=alert_status)](https://community.objectscriptquality.com/dashboard?id=intersystems_iris_community__ks-fhir-gen)
 [![Reliability Rating](https://community.objectscriptquality.com/api/project_badges/measure?project=intersystems_iris_community__ks-fhir-gen&metric=reliability_rating)](https://community.objectscriptquality.com/dashboard?id=intersystems_iris_community__ks-fhir-gen)

[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg?style=flat&logo=AdGuard)](LICENSE)

# ks-fhir-gen

## Description

This is a proposal for a solution described in [HL7 test message generator](https://ideas.intersystems.com/ideas/DPI-I-464) InterSystems Community opportunity idea.

This proof of concept application converts FHIR (Fast Healthcare Interoperability Resources) resources generated by Synthea into HL7 v2 messages.

Synthea, an open-source synthetic patient generator, produces realistic healthcare data in FHIR format. It generates a set of resource bundles containing varied FHIR vR4 resources : Patient, Observation, Encounter, etc. 

The application processes these FHIR resources and transforms them into HL7 v2 messages using DTL data transformations. 

A number of helper functions are available to the transformations to map FHIR values and concepts to HL7 v2 equivalents. FHIR code system URLS are mapped to simpler code system names using a lookup table (LUT).

## Usage



## Prerequisites

Make sure you have [git](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git) and [Docker desktop](https://www.docker.com/products/docker-desktop) installed.

## Installation

Clone/git pull the repo into any local directory.

Use the 'recurse-submodules' option to clone latest synthea version, otherwise leave out and copy your own customized version into the 'synthea' folder

```
$ git clone --recurse-submodules https://github.com/theanor/ks-fhir-gen.git
```

Open the terminal in this directory and call the command to build and run InterSystems IRIS in container:
*Note: Users running containers on a Linux CLI, should use "docker compose" instead of "docker-compose"*
*See [Install the Compose plugin](https://docs.docker.com/compose/install/linux/)*

```
$ docker-compose up -d
```

To open IRIS Terminal do:

```
$ docker-compose exec iris iris session iris -U IRISAPP
IRISAPP>
```

To exit the terminal, do any of the following:

```
Enter HALT or H (not case-sensitive)
```

## How to use the generator

The generator is implemented by a business service class

### business service settings


# Running sample production in the unit tests

The template contains two test classes: `TestObjectScript.cls` and `TestPersistentClass.cls `

To run the unit tests we can use the Package Manager environment.

```
IRISAPP>zpm
...
zpm:IRISAPP>reload ks-fhir-gen
...
zpm:IRISAPP>test ks-fhir-gen
...
All PASSED
...
zpm:IRISAPP>
```

Check out the content of the test/runtime folder 

In case of test errors, you can find more details back in the UnitTest portal, which can be easily opened via ObjectScript menu in VSCode:

![vscvode unittest](https://user-images.githubusercontent.com/2781759/152678943-7d9d9696-e26a-449f-b1d7-f924528c8e3a.png)

If you have installed the [_InterSystems Testing Manager for VS Code_ extension](https://openexchange.intersystems.com/package/InterSystems-Testing-Manager-for-VS-Code)
you can also run unit tests directly from VSCode :
![vscvode unittest](https://raw.githubusercontent.com/intersystems-community/intersystems-testingmanager/main/images/README/Overview-Client.gif)

## Customizing the generator

### creating transforms

### configuring transform selection rules

### using other FHIR data sources

* implement resource indexer interface
* implement reference resolver interface
* extend AbstractGeneratorService







extending generator service



writing transforms 


## In this repository

### Sample FHIR data

test\resource\fhir

### Code system LUT

resource\lut\M~FHIR~HL7.xml

### HL7 output of the test production

test\runtime\HL7\Out

### .vscode folder
Contains two files to setup vscode environment:

#### .vscode/settings.json

Settings file to let you immediately code in VSCode with [VSCode ObjectScript plugin](https://marketplace.visualstudio.com/items?itemName=daimor.vscode-objectscript))

#### .vscode/launch.json

Config file if you want to debug with VSCode ObjectScript

### src folder

Contains source files.
src/iris contains InterSystems IRIS Objectscript code

### tests folder
Contains unit tests for the ObjectScript classes

### dev.md

Contains a set of useful commands that will help during the development

### docker-compose.yml

A docker engine helper file to manage images building and rule ports mapping an the host to container folders(volumes) mapping

### Dockerfile

The simplest dockerfile which starts IRIS and imports code from /src folder into it.
Use the related docker-compose.yml to easily setup additional parametes like port number and where you map keys and host folders.


### iris.script

Contains objectscript commands that are feeded to iris during the image building

### module.xml

IPM Module's description of the code in the repository.
It describes what is loaded with the method, how it is being tested and what apps neeed to be created, what files need to be copied.

[Read about all the files in this artilce](https://community.intersystems.com/post/dockerfile-and-friends-or-how-run-and-collaborate-objectscript-projects-intersystems-iris)



## Troubleshooting

If you have issues with docker image building here are some recipes that could help.

1. You are out of free space in docker. You can expand the amount of space or clean up maually via docker desktop. Or you can call the following line to clean up:
```
docker system prune -f
```

2. We use multi-stage image building which in some cases doesn't work. Switch the target to [builder](https://github.com/intersystems-community/intersystems-iris-dev-template/blob/6ab6791983e5783118efce1777a7671046652e4c/docker-compose.yml#L7) from final in the docker compose and try again.

